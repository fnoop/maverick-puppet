# Mavlink Module
## Mavlink Proxies
Maverick uses *mavlink proxies* to allow multiple connections from the mavlink source.  There are multiple proxy providers, or types, and the configuration and service control of them are automatically generated by Maverick.  The type can be switched by setting a single localconf parameter, eg. to make *mavlink-router* the active proxy for Flight Controller mavlink data:  
`"maverick_fc::mavlink_proxy": "mavlink-router"`
<img src="../media/mavlink-proxy.svg" width="75%">
### Proxy Ports
Maverick sets two proxy environments out of the box - one for FC (Flight Controller) and one for Ardupilot SITL, and a third optional PX4 SITL environment.  There are a default set of endpoints, some of which are reserved or recommended for particular use:  

  | Env | Port | Status
--- | :---: | :---: | ---
TCP | FC | 5770 | TCP allows multiple connections to a port
TCP | FC | 5771 | <font color='gray'>available</font>
TCP | FC | 5772 | <font color='gray'>available</font>
UDP | FC | 14570 | Vision Landing<br><font color='gray'>(available if not using vision_landing)</font>
UDP | FC | 14571 | Web Interface (Reserved)
UDP | FC | 14572 | <font color='gray'>available</font>
UDPin | FC | 14573 | <font color='gray'>available</font>
UDPin | FC | 14574 | <font color='gray'>available</font>
UDPin | FC | 14575 | <font color='gray'>available</font>
--- | --- | --- | ---
TCP | SITL | 5780 | TCP allows multiple connections to a port
TCP | SITL | 5781 | <font color='gray'>available</font>
TCP | SITL | 5782 | <font color='gray'>available</font>
UDP | SITL | 14580 | Vision Landing<br><font color='gray'>(available if not using vision_landing)</font>
UDP | SITL | 14581 | Web Interface (Reserved)
UDP | SITL | 14582 | <font color='gray'>available</font>
UDPin | SITL | 14583 | <font color='gray'>available</font>
UDPin | SITL | 14584 | <font color='gray'>available</font>
UDPin | SITL | 14585 | <font color='gray'>available</font>
--- | --- | --- | ---
TCP | PX4 SITL | 5790 | TCP allows multiple connections to a port
TCP | PX4 SITL | 5791 | <font color='gray'>available</font>
TCP | PX4 SITL | 5792 | <font color='gray'>available</font>
UDP | PX4 SITL | 14590 | Vision Landing<br><font color='gray'>(available if not using vision_landing)</font>
UDP | PX4 SITL | 14591 | Web Interface (Reserved)
UDP | PX4 SITL | 14592 | <font color='gray'>available</font>
UDPin | PX4 SITL | 14593 | <font color='gray'>available</font>
UDPin | PX4 SITL | 14594 | <font color='gray'>available</font>
UDPin | PX4 SITL | 14595 | <font color='gray'>available</font>

The number of ports for each endpoint type can be set for each proxy type and instance.  Each proxy type has an 'instance generator' which is used by other modules to create a proxy instance.  So for example the maverick_fc module creates an instance of maverick_mavlink::mavproxy, or maverick_mavlink::mavlink_router or maverick_mavlink::cmavnode depending on which proxy type is selected.  Each proxy type takes parameters:  
- *startingtcp*: The starting tcp port - maverick_fc starts at 5770 by default, maverick_sitl starts at 5780.
- *tcpports*: The number of tcpports, default is 3.  So maverick_fc would create tcp endpoints for 5770,5771,5772.  Note that not all proxy types support multiple tcp endpoints so this may be silently ignored - MAVProxy is currently the only proxy that supports multiple tcp endpoints.  As tcp endpoints can support multiple connections this does not restrict usage.
- *startingudp*: The starting udp port - maverick_fc starts at 14570 by default, maverick_sitl starts at 14580.
- *udpports*:  The number of udp ports, default is 3.  So maverick_fc would create udp endpoints for 14570,14571,14572.
- *udpinports*:  The number of udpin ports, default is 3.  Note that udpinports start sequentially after udpports, so if there are 3 udpports, the udpinports for maverick_fc would start at 14573 and also create 14574,14575 by default.

These parameters have to be set in the class/module creating the proxy instance, so for the Flight Controller proxy, the localconf parameters would be:  
```puppet
"maverick_fc::mavlink_proxy": "mavproxy",
"maverick_fc::mavlink_startingtcp": 5770,
"maverick_fc::mavlink_tcpports": 3,
"maverick_fc::mavlink_startingudp": 14570,
"maverick_fc::mavlink_udpports": 3,
"maverick_fc::mavlink_udpinports": 3,
```
For Ardupilot SITL, the localconf parameters would be:
```puppet
"maverick_dev::sitl::mavlink_proxy": "mavlink-router",
"maverick_dev::sitl::mavlink_startingtcp": 5780,
"maverick_dev::sitl::mavlink_tcpports": 3,
"maverick_dev::sitl::mavlink_startingudp": 14580,
"maverick_dev::sitl::mavlink_udpports": 3,
"maverick_dev::sitl::mavlink_udpinports": 3,
```
For PX4 SITL, the localconf parameters would be:
```puppet
"maverick_dev::px4::mavlink_proxy": "mavlink-router",
"maverick_dev::px4::mavlink_startingtcp": 5790,
"maverick_dev::px4::mavlink_tcpports": 3,
"maverick_dev::px4::mavlink_startingudp": 14590,
"maverick_dev::px4::mavlink_udpports": 3,
"maverick_dev::px4::mavlink_udpinports": 3,
```

Note that firewall rules are automatically generated for the correct number of tcp and udp ports depending on these settings.

## Proxy Types
The *mavlink* module installs and configures mavlink-related software and libraries, but also provides instances of these software for other modules.  For example, it provides 'cmavnode', 'mavlink-router' and 'mavproxy' components that are called from the maverick_dev and maverick_fc modules to provide mavlink proxy services for the SITL (dev) and FC (flight) environments.

The maverick_mavlink::cmavnode, maverick_mavlink::mavlink_router and maverick_mavlink::mavproxy parameters are therefore not set by the end user or system builder in localconf, but instead are set by calling modules.

There are however a few parameters in the core maverick_mavlink module manifest that can be set, although in practice they will rarely need to be changed.

### cmavnode
cmavnode is a Mavlink proxy type.  Like the other proxies, the software is compiled and installed by default.  This can be disabled by setting localconf parameter:  
`"maverick_mavlink::cmavnode_install": false`  
The github source repo for the software can be changed by setting localconf parameter:  
`"maverick_mavlink::cmavnode:source": "http://github.com/myfork/cmavnode.git"`  

### mavlink-router
Mavlink-router is a mavlink proxy type from 01org (Intel).  It is installed by default, but can be disabled by setting localconf parameter:  
`"maverick_mavlink::mavlink_router_install": false`  
The github source repo for the software can be changed by setting localconf parameter:  
`"maverick_mavlink::mavlink_router_source": "http://github.com/myfork/mavlink-router.git"`  

### MAVProxy
MAVProxy is the traditional and most mature mavlink proxy type.  It is installed by default, but can be disabled by setting localconf parameter:  
`"maverick_mavlink::mavproxy_install": false`  
By default it is installed using 'pip' and installs the latest release available from pip.  This can be changed to a source install by setting localconf parameter:  
`"maverick_mavlink::mavproxy_type": "source"`  
The github source repo for the source install can be changed by setting localconf parameter:  
`"maverick_mavlink::mavproxy_source": "http://github.com/myfork/mavproxy.git"`  

## Mavlink Applications
### MAVCesium
MAVCesium is a great realtime HUD/map display system for autopilots, based on Cesium.  It used to be based on MAVProxy but has recently been separated so it can run on its own.  It is installed by default, and points to the flight controller mavlink proxy.  MAVCesium runs it's own webserver (tornado) but like other Maverick components is reverse proxied to the standard web port under the URL /mavlink/mavcesium/websocket/.  
MAVCesium install can be disabled by setting localconf parameter:  
`"maverick_mavlink::mavcesium_install": false`  
The default web port is 6791, but this can be altered by setting localconf parameter:  
`"maverick_mavlink::mavcesium_port": 1234`  
MAVCesium uses Bing to retrieve map tiles from.  To specify your own Bing api key, set localconf parameter:  
`"maverick_mavlink::mavcesium_apikey": "xxx"`  
The github source can be changed by setting localconf parameter:  
`"maverick_mavlink::mavcesium_source": "http://github.com/myfork/MAVCesium.git"`  
The default mavlink port that MAVCesium connects to can be set by localconf parameter:  
`"maverick_mavlink::mavcesium_mavlink_port": "5770"`
This changes the port specified in *~/config/mavlink/mavcesium.conf*.  Note that this config file is only written if it doesn't already exist - once it exists it is not updated by Maverick.  This is deliberate, so users can change the port dynamically without having to run Maverick.  
MAVCesium is *not* set to run by default.  To start it, and enable it at boot time, set localconf parameter:  
`"maverick_mavlink::mavcesium_active": true`